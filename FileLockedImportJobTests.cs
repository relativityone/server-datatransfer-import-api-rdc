// ----------------------------------------------------------------------------
// <copyright file="FileLockedImportJobTests.cs" company="kCura Corp">
//   kCura Corp (C) 2017 All Rights Reserved.
// </copyright>
// ----------------------------------------------------------------------------

namespace kCura.WinEDDS.TApi.NUnit.Integration
{
    using System.Data;

    using global::NUnit.Framework;

    using global::Relativity.Transfer.UnitTestFramework;

    /// <summary>
    /// Represents integration tests cases involving multiple clients and file locked scenarios.
    /// </summary>
    [TestFixture]
    public class FileLockedImportJobTests : ImportJobTestBase
    {
        /// <summary>
        /// Should import the files.
        /// </summary>
        /// <param name="client">
        /// The transfer client to force.
        /// </param>
        /// <param name="workspaceWithAspera">
        /// Specify whether to use a workspace with Aspera configured.
        /// </param>
        /// <param name="disableNativeLocationValidation">
        /// Specify whether to disable native location validation.
        /// </param>
        /// <param name="disableNativeValidation">
        /// Specify whether to disable native validation.
        /// </param>
        [Test]
        [TestCase(TapiClient.Direct, false, false, true)]
        [TestCase(TapiClient.Direct, false, true, true)]
        [TestCase(TapiClient.Web, false, false, true)]
        [TestCase(TapiClient.Web, false, true, true)]
        [TestCase(TapiClient.Aspera, true, false, true)]
        [TestCase(TapiClient.Aspera, true, true, true)]
        public void ShouldFailWhenTheFileIsLocked(TapiClient client, bool workspaceWithAspera, bool disableNativeLocationValidation, bool disableNativeValidation)
        {
            const int AutoGeneratedSourceFiles = 5;

            // Intentionally provide an invalid file before adding valid ones.
            this.GivenTheAutoGeneratedDatasetToImport(AutoGeneratedSourceFiles, false);
            this.GivenTheSourceFileIsLocked(2);
            this.GivenTheTestInstance(TestEnvironment.OnPremisePrivateCloud);
            this.GivenTheWorkspaceId(
                workspaceWithAspera
                    ? this.TestInstance.WorkspaceIdWithAspera
                    : this.TestInstance.WorkspaceIdWithoutAspera);
            this.GivenTheImportJob();
            this.GivenTheStandardConfigSettings(client, disableNativeLocationValidation, disableNativeValidation);
            this.WhenExecutingTheJob();
            this.ThenTheImportJobIsNotSuccessful(0, AutoGeneratedSourceFiles, true);
            
            // The exact value is impossible to predict.
            this.ThenTheImportProgressEventsCountIsNonZero();
            this.ThenTheImportMessageCountIsNonZero();
        }

        /// <inheritdoc />
        protected override void OnPreTearDown()
        {
            foreach (DataRow file in this.SourceData.Rows)
            {
                var filePath = file[1].ToString();
                ImportJobTestBase.ChangeFileFullPermissions(filePath, true);
            }

            base.OnPreTearDown();
        }
    }
}